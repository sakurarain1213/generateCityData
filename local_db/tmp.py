"""
生成全量type数据的脚本
从数据库中提取所有唯一的type_id，为每个type生成337个城市的完整人口分布数据
"""

import json
import random
from pathlib import Path

# type数据文件路径
TYPE_FEATURES_PATH = r"C:\Users\w1625\Desktop\经济学模拟\cityDataGenerate\output\type_features.jsonl"

# 输出文件路径
OUTPUT_PATH = Path(__file__).parent / "full_type_data.jsonl"

# 城市代码列表（337个）
CITY_CODES = [
    "1100", "1200", "1301", "1302", "1303", "1304", "1305", "1306", "1307", "1308",
    "1309", "1310", "1311", "1401", "1402", "1403", "1404", "1405", "1406", "1407",
    "1408", "1409", "1410", "1411", "1501", "1502", "1503", "1504", "1505", "1506",
    "1507", "1508", "1509", "1522", "1525", "1529", "2101", "2102", "2103", "2104",
    "2105", "2106", "2107", "2108", "2109", "2110", "2111", "2112", "2113", "2114",
    "2201", "2202", "2203", "2204", "2205", "2206", "2207", "2208", "2224", "2301",
    "2302", "2303", "2304", "2305", "2306", "2307", "2308", "2309", "2310", "2311",
    "2312", "2327", "3100", "3201", "3202", "3203", "3204", "3205", "3206", "3207",
    "3208", "3209", "3210", "3211", "3212", "3213", "3301", "3302", "3303", "3304",
    "3305", "3306", "3307", "3308", "3309", "3310", "3311", "3401", "3402", "3403",
    "3404", "3405", "3406", "3407", "3408", "3410", "3411", "3412", "3413", "3415",
    "3416", "3417", "3418", "3501", "3502", "3503", "3504", "3505", "3506", "3507",
    "3508", "3509", "3601", "3602", "3603", "3604", "3605", "3606", "3607", "3608",
    "3609", "3610", "3611", "3701", "3702", "3703", "3704", "3705", "3706", "3707",
    "3708", "3709", "3710", "3711", "3713", "3714", "3715", "3716", "3717", "4101",
    "4102", "4103", "4104", "4105", "4106", "4107", "4108", "4109", "4110", "4111",
    "4112", "4113", "4114", "4115", "4116", "4117", "4201", "4202", "4203", "4205",
    "4206", "4207", "4208", "4209", "4210", "4211", "4212", "4213", "4228", "4301",
    "4302", "4303", "4304", "4305", "4306", "4307", "4308", "4309", "4310", "4311",
    "4312", "4313", "4331", "4401", "4402", "4403", "4404", "4405", "4406", "4407",
    "4408", "4409", "4412", "4413", "4414", "4415", "4416", "4417", "4418", "4419",
    "4420", "4451", "4452", "4453", "4501", "4502", "4503", "4504", "4505", "4506",
    "4507", "4508", "4509", "4510", "4511", "4512", "4513", "4514", "4601", "4602",
    "4603", "4604", "5000", "5101", "5103", "5104", "5105", "5106", "5107", "5108",
    "5109", "5110", "5111", "5113", "5114", "5115", "5116", "5117", "5118", "5119",
    "5120", "5132", "5133", "5134", "5201", "5202", "5203", "5204", "5205", "5206",
    "5223", "5226", "5227", "5301", "5303", "5304", "5305", "5306", "5307", "5308",
    "5309", "5323", "5325", "5326", "5328", "5329", "5331", "5333", "5334", "5401",
    "5402", "5403", "5404", "5405", "5406", "5425", "6101", "6102", "6103", "6104",
    "6105", "6106", "6107", "6108", "6109", "6110", "6201", "6202", "6203", "6204",
    "6205", "6206", "6207", "6208", "6209", "6210", "6211", "6212", "6229", "6230",
    "6301", "6302", "6322", "6323", "6325", "6326", "6327", "6328", "6401", "6402",
    "6403", "6404", "6405", "6501", "6502", "6504", "6505", "6523", "6527", "6528",
    "6529", "6530", "6531", "6532", "6540", "6542", "6543"
]

def get_all_type_ids(jsonl_path: str) -> list[str]:
    """
    从type_features.jsonl文件中提取所有type_id
    """
    type_ids = []

    with open(jsonl_path, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                record = json.loads(line)
                type_ids.append(record['id'])

    return type_ids


def generate_city_population() -> dict[str, int]:
    """
    为一个type生成所有337个城市的人口分布

    人口随机生成，基准1000，浮动范围±50% (500-1500)
    """
    city_population = {}

    for city_code in CITY_CODES:
        # 基准1000，随机浮动±50%
        base = 1000
        variation = random.uniform(-0.5, 0.5)  # -50% 到 +50%
        population = int(base * (1 + variation))
        city_population[city_code] = population

    return city_population


def generate_full_type_data(type_features_path: str, output_path: Path):
    """
    生成全量type数据并保存到jsonl文件
    """
    print(f"正在读取type数据: {type_features_path}")
    type_ids = get_all_type_ids(type_features_path)
    print(f"找到 {len(type_ids)} 个唯一的type_id")

    print(f"\n正在生成数据，输出到: {output_path}")

    with open(output_path, 'w', encoding='utf-8') as f:
        for i, type_id in enumerate(type_ids, 1):
            # 生成该type的城市人口分布
            city_population = generate_city_population()

            # 创建记录
            record = {
                "id": type_id,
                "city_population": city_population
            }

            # 写入jsonl文件（每行一个JSON对象）
            f.write(json.dumps(record, ensure_ascii=False) + '\n')

            if i % 100 == 0:
                print(f"已处理 {i}/{len(type_ids)} 个type")

    print(f"\n完成！共生成 {len(type_ids)} 条记录")
    print(f"文件已保存到: {output_path}")


if __name__ == "__main__":
    # 设置随机种子以便复现（可选）
    random.seed(42)

    generate_full_type_data(TYPE_FEATURES_PATH, OUTPUT_PATH)
