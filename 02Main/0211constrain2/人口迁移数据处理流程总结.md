# 人口迁移数据处理流程总结

## 1. 数据处理流程概述

本文档说明从2000/2005/2010/2015年原始普查微观数据到最终2000-2020年完整城市流出数据的完整处理流程。

---

## 2. 处理流程

### Step 1: 计算对称迁移矩阵 (step1_calculate_symmetric_migration.py)

**输入：** 2000/2005/2010/2015年普查微观数据
**输出：** `{year}_migration_symmetric_od_matrix.csv`

**核心逻辑：**
```
is_migrant = (hukou_city != current_city) AND (离开5年以上 OR 迁移原因符合条件)
migration_count = sum(is_migrant) 按origin_city × dest_city分组聚合
```

**关键处理：**
- 使用`valid_r61_values`筛选有效的迁移原因
- 计算常住人口、样本人口、户籍人口
- 生成对称OD矩阵（origin → dest）

---

### Step 2: 估计实际迁移量 (step2_estimate_actual_migration.py)

**输入：** `{year}_migration_symmetric_od_matrix.csv`
**输出：** `{year}_estimated_od_matrix.csv`, `{year}_estimated_od_matrix_scaling_factors.csv`

**核心逻辑：**
```
放大比例 = 常住人口 / 样本人口
estimated_migration = migration_count × 放大比例
```

**重要说明：**
- 使用dest_city的放大比例（因为统计的是迁入人口）
- 2000年使用`2000_estimated_od_matrix_fixed.csv`（修正了样本人口计算错误）

---

### Step 3: 生成Top20流出数据 (step4_generate_top20_outflow.py)

**输入：** `{year}_estimated_od_matrix.csv`, 城市常住人口数据
**输出：** `city_outflow_complete_{year}.xlsx`

**核心逻辑：**
```
对于每个origin_city:
  1. 取Top20目的地（按estimated_migration排序）
  2. 计算Total_Count = 常住人口数
  3. 计算Outflow_Count = 所有estimated_migration之和
  4. 计算Stay_Prob = 1 - Outflow_Count / Total_Count
  5. 填充Top20字段及其Count
```

**列结构：** Year, Month, From_City, Total_Count, Stay_Prob, Outflow_Count, To_Top1~20, To_Top1~20_Count

---

### Step 4: 跨年份插值 (interpolate_outflow_v11.py)

**输入：** 2000/2005/2010/2015年的Top20数据
**输出：** `city_outflow_interpolated_2000_2020_v11.csv`

**核心逻辑：**
```
对于每个城市:
  1. 提取锚点年份数据
  2. 使用PCHIP插值计算2000-2020每年的Outflow_Count
  3. 计算Stay_Prob确保公式成立
  4. 对于非锚点年份，使用邻近锚点年的Top20目的地
```

**插值方法：** PCHIP（分段三次Hermite插值），保持单调性和平滑性

---

### Step 5: 生成完整数据 (generate_complete_outflow_v15a.py)

**输入：** `city_outflow_interpolated_2000_2020_v11.csv`, `estimated_od_matrix`数据
**输出：** `city_outflow_complete_2000_2020_v15a.xlsx`

**核心逻辑：**
```
对于每年(2000-2020):
  1. 计算缩放因子使全国总量匹配v10目标趋势
  2. 对于有estimated_od_matrix数据的年份/城市：
     - 使用amplified Top20数据
     - 按比例分配确保Top20总和 ≤ Outflow_Count
  3. 对于无OD矩阵数据的年份/城市：
     - 使用全国平均目的地分布
  4. 修复9个2010年问题城市（使用OD矩阵数据）
```

**v10目标总量（万人）：**
| 年份 | 2000 | 2005 | 2010 | 2014 | 2015 | 2020 |
|------|------|------|------|------|------|------|
| 目标 | 4100 | 7900 | 11200 | 12600 | 10300 | 15700 |

---

## 3. 约束条件验证

所有输出数据严格满足以下6项约束：

### 约束1: 公式约束
**定义：** `Total_Count × (1 - Stay_Prob) = Outflow_Count`

**说明：** 这是数据模型的核心公式，确保人口守恒。总人口减去迁出人口等于留存人口，反之亦然。

**验证结果：** ✅ PASS (max_diff < 0.01)

**实现方式：** 先计算Total_Count和Outflow_Count，再反推Stay_Prob：
```python
Stay_Prob = 1 - Outflow_Count / Total_Count
```

---

### 约束2: Top20总和约束
**定义：** `Sum(Top1_Count, Top2_Count, ..., Top20_Count) ≤ Outflow_Count`

**说明：** Top20目的地的迁出人口之和不能超过该城市的总迁出人口。

**验证结果：** ✅ PASS (0违规)

**实现方式：** 使用比例分配算法，当总和超过Outflow时，从最大的项中减去超出的部分：
```python
if top20_sum > outflow:
    excess = top20_sum - outflow
    # 从最大的Top20项减去超出部分
```

---

### 约束3: 非负约束
**定义：**
- `Outflow_Count ≥ 0`（迁出人口非负）
- `0 ≤ Stay_Prob ≤ 1`（留存概率在[0,1]区间）
- `Total_Count ≥ 0`（总人口非负）
- `Top{i}_Count ≥ 0`（各Top20迁出量非负）

**验证结果：** ✅ PASS

**实现方式：** 在计算过程中使用max()函数确保非负：
```python
Stay_Prob = max(0.0, min(1.0, Stay_Prob))
Outflow_Count = max(0, Outflow_Count)
```

---

### 约束4: Top20完整性约束
**定义：** 所有Outflow_Count > 0的城市都必须有Top20数据（至少Top1）

**说明：** 如果一个城市有迁出人口，就应该记录其主要迁入目的地。

**验证结果：** ✅ PASS (0缺失)

**实现方式：**
- 有OD矩阵数据时：直接使用Top20
- 无OD矩阵数据时：使用全国平均目的地分布
- Outflow较小时（<20）：限制Top20数量，但至少保留Top1

---

### 约束5: 直辖市代码规范约束
**定义：** 直辖市使用00结尾的城市代码

**规范：**
| 直辖市 | 正确代码 | 错误代码 |
|--------|----------|----------|
| 北京市 | 1100 | 1101 |
| 天津市 | 1200 | 1201 |
| 上海市 | 3100 | 3101 |
| 重庆市 | 5000 | 5001 |

**验证结果：** ✅ PASS

**实现方式：** 使用standardize_municipality_code()函数统一转换：
```python
def standardize_municipality_code(code):
    mapping = {'1101': '1100', '1201': '1200', '3101': '3100', '5001': '5000'}
    return mapping.get(str(code).zfill(4), str(code).zfill(4))
```

**注意：** 其他省会城市使用01结尾是正确的（如1301=石家庄市），只有4个直辖市需要映射。

---

### 约束6: 全国趋势匹配约束
**定义：** 全国总迁出人口应匹配v10目标趋势

**目标总量（万人）：**
| 年份 | 2000 | 2005 | 2010 | 2014 | 2015 | 2020 |
|------|------|------|------|------|------|------|
| 目标 | 4100 | 7900 | 11200 | 12600 | 10300 | 15700 |

**验证结果：** ✅ PASS (差异<1%)

**实现方式：** 计算每年缩放因子并应用到所有城市：
```python
scale_factor = target_total / current_total
scaled_outflow = outflow × scale_factor
```

**趋势特征：**
- 2000-2014：持续增长（反映城镇化加速）
- 2014峰值：12600万（人口迁移最高点）
- 2015-2019：下降（经济结构调整、人口回流）
- 2020年：15700万（疫情影响统计口径）

---

## 4. 人口迁移趋势对比图

### 全国流出人口趋势（2000-2020）

```
流出人口（万人）
16000 |                                    ● 2020
      |                              /
14000 |                             /
      |                           /
12000 |              /-----------● 2014 (峰值)
      |            /
10000 |          /
      |        /
8000  |------● 2005
      |
6000  |----● 2000
      |
4000  |
      +----|----|----|----|----|----|----|----|----|----|
      2000 2002 2004 2006 2008 2010 2012 2014 2016 2018 2020
```

**趋势特征：**
- **2000-2014：** 持续增长，2014年达到峰值12600万
- **2015-2019：** 显著下降，反映经济结构调整和人口回流
- **2020年：** 骤增至15700万，受疫情影响（统计口径变化、临时返乡等）

### 主要迁入目的地

全国范围内，Top迁入目的地为：
1. **北京市(1100)** - 首都，政治经济中心
2. **上海市(3100)** - 经济金融中心
3. **广州市(4401)** - 珠三角核心
4. **深圳市(4403)** - 科技创新中心
5. **东莞市(4419)** - 制造业中心

---

## 5. 数据不完全性的可解释性

### 5.1 年份覆盖不完全

**原因：** 中国人口普查每10年一次（2000, 2010），1%抽样调查每5年一次（2005, 2015）

**处理方法：**
- 锚点年份（2000/2005/2010/2015）：使用普查/抽样数据
- 非锚点年份：使用PCHIP插值
- 2016-2019年：基于2015年数据外推
- 2020年：受疫情影响，根据v10趋势调整

### 5.2 城市覆盖不完全

**原因：**
- 普查样本中部分城市迁移样本量过少
- 部分城市行政区划变更
- 部分数据在预处理阶段被过滤

**处理方法：**
- **有OD数据：** 使用estimated_od_matrix的amplified数据
- **无OD数据：** 使用全国平均目的地分布
- **9个2010年问题城市：** 直接从OD矩阵提取并修复

### 5.3 迁移方向的不完全性

**说明：**
- 数据仅包含"样本中观测到的迁移"
- 对于样本量为0的城市对，无法估计迁移量
- 迁移量按比例放大，但模式可能存在偏差

### 5.4 数据质量指标

| 指标 | 说明 |
|------|------|
| 样本覆盖率 | ~1%（2000/2010普查） |
| 插值置信度 | 锚点年份高，中间年份中等 |
| 城市覆盖率 | 约300个城市（全部地级市） |

---

## 6. 数据使用建议

1. **推荐用途：** 宏观趋势分析、区域间人口流动研究、政策制定参考
2. **谨慎使用场景：** 微观层面精确迁移量、小城市迁移模式
3. **置信度：** 锚点年份 > 插值年份 > 外推年份

---

## 7. 输出文件说明

### city_outflow_complete_2000_2020_v15a.xlsx

**总记录数：** 6302条（约300个城市 × 21年）

**列说明：**
- `Year`: 年份 (2000-2020)
- `Month`: 月份 (固定为12)
- `From_City`: 迁出城市（格式：城市名(城市代码)）
- `Total_Count`: 该城市总人口（人）
- `Stay_Prob`: 留存概率 (0-1)
- `Outflow_Count`: 迁出人口（人）
- `To_Top1~20`: Top20迁入城市
- `To_Top1~20_Count`: 对应迁入人口

**验证状态：** ✅ 所有约束条件满足
